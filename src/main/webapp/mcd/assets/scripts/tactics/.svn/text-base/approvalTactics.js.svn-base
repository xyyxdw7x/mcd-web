define(["backbone"],function(require, exports, module) {      
	module.exports={
		init:function(){
			//详情
			var getcampsegId=window.location.search.substr(1).split("&")[0].split("=")[1];
			this.loadTacticDetail({
				ajaxData:{
					campsegId:getcampsegId
				},
				domCallback:this.getSubCampsegId
			});
			
			//选项卡功能
			//this.tacticsInfoTab();
			
			//日志
			//没数据暂时注释掉=====不要删除
			/*
			this.getLogRecord({
				ajaxData:{
					campsegId:getcampsegId
				}
			});
			*/
			$(".ui-next-icon").click(function(){
				if($(".approval-tab-item:not(:hidden)").last().next().next().length > 0){
					$(".approval-tab-item:not(:hidden)").first().hide();
					$(".approval-tab-item:not(:hidden)").last().next().next().show();
				}
			});
			$(".ui-prev-icon").click(function(){
				if($(".approval-tab-item:not(:hidden)").first().prev().prev().length > 0){
					$(".approval-tab-item:not(:hidden)").last().hide();
					$(".approval-tab-item:not(:hidden)").first().prev().prev().show();
				}
			});
		},
		tokenVerification:function(options){
			var defaults = {
					urlRoot:_ctx+"/mpm",
					id:"iMcdviewPolicyDetail.aido",
					cmd:"tokenVerification",
					ajaxData:{},
					domCallback:function(){}
			};
			options = $.extend(defaults, options);
		},
		
		tacticsInfoTab:function(){
			var tacticsInfoView = Backbone.View.extend({
				events : { 
					"click" : "click"
				},
				click : function(obj) {
					var $target =  $(obj.target);
					if($target.hasClass("active")) return;
					var _index=$target.parent().find("li").index($target[0]);
					$target.addClass("active").siblings(".active").removeClass("active");
					$("body").find("> .tabbox").eq(_index).addClass("active").siblings(".active").removeClass("active");
				},
				initialize : function() {
					this.render();
				},
				render : function() { 
					return this;
				} 
			});
			new tacticsInfoView({el:"#tactics-state-tab"});
		},
		loadTacticDetail:function(options){
			var defaults = {
					urlRoot:_ctx+"/mpm",
					id:"iMcdviewPolicyDetail.aido",
					cmd:"viewPolicyDetail",
					currentDom:"#tacticsDetail",
					ejsUrl:_ctx + '/mcd/pages/EJS/tacticsInfo/approvalInfoDetal.ejs',
					ajaxData:{},
					domCallback:function(){}
			};
			options = $.extend(defaults, options);
			var tacticsInfoDetailModel = Backbone.Model.extend({
				urlRoot : options.urlRoot,
				defaults : {
					_ctx : _ctx
				}
			}); 
			var tacticsInfoDetailView = Backbone.View.extend({
				model : new tacticsInfoDetailModel({id : options.id}), 
				initialize : function() {
					this.render();
				},
				render : function() { 
					this.setDomList(this.model);
					return this;
				} ,
				setDomList:function(md){
					var defaultData = {cmd:options.cmd};
					var ajaxData = $.extend(defaultData, options.ajaxData);
					md.fetch({
						type : "post",
						contentType: "application/x-www-form-urlencoded; charset=utf-8",
						dataType:'json',
						data:defaultData,
						success:function(model) {
							var _Html = new EJS({
								url : options.ejsUrl
							}).render(model.attributes);
							$(options.currentDom).html(_Html);
							options.domCallback();
						}
					});
				}
			});
			new tacticsInfoDetailView({el:options.currentDom});
		},
		getSubCampsegId:function(){
			//根据子id获取每个规则下面的数据:
			var subCampsegIdCTList=$("#subCampsegIdCT span");
			var boxesCT=$("#subCamsegBoxesCT");
			var subSegtabCT=$("#subCamsegTab");
			var len = subCampsegIdCTList.length;
			if(len > 10){
				$(".approval-tactics-tabs  > i").show();
			}else{
				$(".approval-tactics-tabs  > i").hide();
			}
			for(var i=0;i<len;i++){
				var subCampsegId=subCampsegIdCTList.eq(i).html();
				if(subCampsegId==""){
					len = i;
					break;
				}
				var _htm='<div class="box">';
				_htm+='<div class="content">';
				_htm+='<div class="content-main">';
				_htm+='<div class="mtlStcPlan content-table"></div>';
				_htm+='</div></div>';
				
				_htm+='<div class="content">';
				_htm+='<div class="content-main">';
				_htm+='<div class="targetCustomerbase content-table"></div>';
				_htm+='</div></div>';
				
				_htm+='<div class="content">';
				_htm+='<div class="content-main">';
				_htm+='<div class="deliveryChannelView content-table"></div>';
				_htm+='</div></div>';
				
				_htm+='</div>';
				var _htmobj=$(_htm);
				module.exports.getMtlStcPlan({
					currentDom:_htmobj.find(".mtlStcPlan"),
					ajaxData:{
						campsegId:subCampsegId
					}
				});
				module.exports.getTargetCustomerbase({
					currentDom:_htmobj.find(".targetCustomerbase"),
					ajaxData:{
						campsegId:subCampsegId
					}
				});
				module.exports.getDeliveryChannel({
					currentDom:_htmobj.find(".deliveryChannelView"),
					ajaxData:{
						campsegId:subCampsegId
					}
				});
				if(i==0) _htmobj.css('display','block');
				else _htmobj.css('display','none');
				boxesCT.append(_htmobj);
				
				var _html='';
				if(i>0){
					if(i>9){
						_html+='<div class="left-nav-line"></div>';
						_html+='<div class="fleft approval-tab-item " style="display:none;">';
					}else{
						_html+='<div class="left-nav-line"></div>';
						_html+='<div class="fleft approval-tab-item ">';
					}
					
				}else{
					_html+='<div class="fleft approval-tab-item active">';
				}
				_html+='<span class="left-nav-bg" data-num="'+(i+1)+'">规则'+(i+1)+'</span>';
				_html+='</div>';
				var _htmlobj=$(_html);
				
				subSegtabCT.append(_htmlobj);
				
				//规则列表选项卡
				
				$("#subCamsegTab .left-nav-bg").on("click",function(){
					if($(this).parent().hasClass(".approval-tab-item.active")) {
						var _index=$(this).parent().hasClass(".approval-tab-item.active").index($(this)[0]);
						$("#subCamsegBoxesCT .box").eq(_index).css('display','block').siblings(".box").css('display','none');
						return;
					}
					var _index=$(this).parents("#subCamsegTab").find(".left-nav-bg").index($(this)[0]);
					$(this).parents("#subCamsegTab").find(".approval-tab-item ").eq(_index).addClass("active").siblings(".approval-tab-item.active").removeClass("active");
//					$("#subCamsegBoxesCT .box").eq(_index).addClass("active").siblings(".active").removeClass("active");
					$("#subCamsegBoxesCT .box").eq(_index).css('display','block').siblings(".box").css('display','none');
				});
			}
			//end
		},
		getMtlStcPlan:function(options){
			var defaults = {
					urlRoot:_ctx+"/mpm",
					id:"iMcdviewPolicyDetail.aido",
					cmd:"getMtlStcPlan",
					currentDom:"#mtlStcPlan",
					ejsUrl:_ctx + '/mcd/pages/EJS/tacticsInfo/approvalMtlStcPlan.ejs',
					ajaxData:{}
			};
			options = $.extend(defaults, options);
			var tacticsInfoMtlStcPlanModel = Backbone.Model.extend({
				urlRoot : options.urlRoot,
				defaults : {
					_ctx : _ctx
				}
			}); 
			var tacticsInfoMtlStcPlanView = Backbone.View.extend({
				events : { 
					"click" : "click"
				},
				click:function(obj){
					var $target =  $(obj.target);
					var showtar=$target.parents(".J_click").next(".mtlStcPlanDetailTr");
					if(showtar.hasClass("active")){
						showtar.hide().removeClass("active");
					}else{
						showtar.show().addClass("active");
					}
				},
				model : new tacticsInfoMtlStcPlanModel({id : options.id}), 
				initialize : function() {
					this.render();
				},
				render : function() { 
					this.setDomList(this.model);
					return this;
				} ,
				setDomList:function(md){
					var defaultData = {cmd:options.cmd};
					var ajaxData = $.extend(defaultData, options.ajaxData);
					md.fetch({
						type : "post",
						contentType: "application/x-www-form-urlencoded; charset=utf-8",
						dataType:'json',
						data:defaultData,
						success:function(model) {
							var _Html = new EJS({
								url : options.ejsUrl
							}).render(model.attributes);
							$(options.currentDom).html(_Html);
						}
					});
				}
			});
			new tacticsInfoMtlStcPlanView({el:options.currentDom});
		},
		getTargetCustomerbase:function(options){
			var defaults = {
					urlRoot:_ctx+"/mpm",
					id:"iMcdviewPolicyDetail.aido",
					cmd:"getTargetCustomerbase",
					currentDom:"#targetCustomerbase",
					ejsUrl:_ctx + '/mcd/pages/EJS/tacticsInfo/approvaltargetCustomerbase.ejs',
					ajaxData:{}
			};
			options = $.extend(defaults, options);
			var tacticsInfoGetTargetCustomerbaseModel = Backbone.Model.extend({
				urlRoot : options.urlRoot,
				defaults : {
					_ctx : _ctx
				}
			}); 
			var tacticsInfoGetTargetCustomerbaseView = Backbone.View.extend({
				model : new tacticsInfoGetTargetCustomerbaseModel({id : options.id}), 
				initialize : function() {
					this.render();
				},
				render : function() { 
					this.setDomList(this.model);
					return this;
				} ,
				setDomList:function(md){
					var defaultData = {cmd:options.cmd};
					var ajaxData = $.extend(defaultData, options.ajaxData);
					md.fetch({
						type : "post",
						contentType: "application/x-www-form-urlencoded; charset=utf-8",
						dataType:'json',
						data:defaultData,
						success:function(model) {
							var _Html = new EJS({
								url : options.ejsUrl
							}).render(model.attributes);
							$(options.currentDom).html(_Html);
						}
					});
				}
			});
			new tacticsInfoGetTargetCustomerbaseView({el:options.currentDom});
		},
		getDeliveryChannel:function(options){
			var defaults = {
					urlRoot:_ctx+"/mpm",
					id:"iMcdviewPolicyDetail.aido",
					cmd:"getDeliveryChannel",
					currentDom:"#deliveryChannelView",
					ejsUrl:_ctx + '/mcd/pages/EJS/tacticsInfo/approvalDeliveryChannel.ejs',
					ajaxData:{}
			};
			options = $.extend(defaults, options);
			var getDeliveryChannelModel = Backbone.Model.extend({
				urlRoot : options.urlRoot,
				defaults : {
					_ctx : _ctx
				}
			}); 
			var getDeliveryChannelView = Backbone.View.extend({
				model : new getDeliveryChannelModel({id : options.id}), 
				initialize : function() {
					this.render();
				},
				render : function() { 
					this.setDomList(this.model);
					return this;
				} ,
				setDomList:function(md){
					var defaultData = {cmd:options.cmd};
					var ajaxData = $.extend(defaultData, options.ajaxData);
					md.fetch({
						type : "post",
						contentType: "application/x-www-form-urlencoded; charset=utf-8",
						dataType:'json',
						data:defaultData,
						success:function(model) {
							var _Html = new EJS({
								url : options.ejsUrl
							}).render(model.attributes);
							$(options.currentDom).html(_Html);
						}
					});
				}
			});
			new getDeliveryChannelView({el:options.currentDom});
		},
		getLogRecord:function(options){
			var defaults = {
					urlRoot:_ctx+"/mpm",
					id:"iMcdviewPolicyDetail.aido",
					cmd:"getLogRecord",
					currentDom:"#logRecordCT",
					ejsUrl:_ctx + '/mcd/pages/EJS/tacticsInfo/logRecord.ejs',
					ajaxData:{}
			};
			options = $.extend(defaults, options);
			var getLogRecordModel = Backbone.Model.extend({
				urlRoot : options.urlRoot,
				defaults : {
					_ctx : _ctx
				}
			}); 
			var getLogRecordView = Backbone.View.extend({
				model : new getLogRecordModel({id : options.id}), 
				initialize : function() {
					this.render();
				},
				render : function() { 
					this.setDomList(this.model);
					return this;
				} ,
				setDomList:function(md){
					var defaultData = {cmd:options.cmd};
					var ajaxData = $.extend(defaultData, options.ajaxData);
					md.fetch({
						type : "post",
						contentType: "application/x-www-form-urlencoded; charset=utf-8",
						dataType:'json',
						data:defaultData,
						success:function(model) {
							var _Html = new EJS({
								url : options.ejsUrl
							}).render(model.attributes);
							$(options.currentDom).html(_Html);
						}
					});
				}
			});
			new getLogRecordView({el:options.currentDom});
		}
	};
});